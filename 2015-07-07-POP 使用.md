---
layout: post
title: "POP 使用"
description: ""
category: ios 开发
tags: [pop]
author: ciefky
---  

*序：每个view都有一个layer，layer主要负责渲染，view只是在layer的基础上增加了Event Handle一类的东西，实际上你调整view的frame也好，调backgroundcolor也罢，这类负责展示的属性实际上都是在调整layer的对应属性。动画无非就是layer层的再次渲染*

一个优秀的动画肯定不是由一个单元的效果，或者单一的时间线（timingfuntion）组成的，而是由多种不同的效果组成。

**Facebook官方阐述：**

 Pop是一个适用于iOS和OS X平台的可扩展动画引擎。除了基本的静态动画，Pop还支持spring和decay动画，有助于打造一个逼真的，基于物理的交互。你可以通过Pop的API把Pop快速集成到现有的Objective-C代码库中，并在任何对象上实现动画的任何属性。这是一个成熟的并且经过良好测试的框架，承载了Paper中所有的动画和交互。

###类型

Pop有四个具体的动画类型：spring, decay, basic和custom。

Spring动画可以用来给对象一个令人愉悦的弹跳效果。在这个例子中，我们用spring动画来动画一个层次的弹跳效果，从现有的值设定为(0, 0, 400, 400)。

    POPSpringAnimation *anim = [POPSpringAnimation animationWithPropertyNamed:kPOPLayerBounds]; 
    anim.toValue = [NSValue valueWithCGRec 
    t:CGRectMake(0, 0, 400, 400)]; 
    [layer pop_addAnimation:anim forKey:@"size"]; 

Decay动画能用于逐渐减慢一个对象直至停止。在这个例子中，我们将layer的速率减小为每秒钟1000pts。

    POPDecayAnimation *anim = [POPDecayAnimation animationWithPropertyNamed:kPOPLayerPositionX]; 
    anim.velocity = @(1000.); 
    [layer pop_addAnimation:anim forKey:@"slide"]; 

basic基本动画能用于在指定的时间段插入值。使用一个淡入淡出动画在默认时间段将视图的透明度从0.0设置为1.0。

    POPBasicAnimation *anim = [POPBasicAnimation animationWithPropertyNamed:kPOPViewAlpha]; 
    anim.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseInEaseOut]; 
    anim.fromValue = @(0.0); 
    anim.toValue = @(1.0); 
    [view pop_addAnimation:anim forKey:@"slide"]; 

通过处理CADisplayLink和相关的time-step管理，POPCustomAnimation使创建自定义动画和过渡变得更加容易。更多详情请查看header。
###常用类
**POPBasicAnimation**

**POPDecayAnimation**

**POPPropertyAnimation**

**POPSpringAnimation**

**POPCustomAnimation**

**POPAnimation**

**POPAnimatableProperty**

**Pop Animation自带的动画都是基于POPPropertyAnimation的，POPPropertyAnimation有个很重要的部分就是 POPAnimatableProperty，用来描述animatable的属性。**

####POPAnimatableProperty
如下：

    /**
     Common CALayer property names.
     */
    extern NSString * const kPOPLayerBackgroundColor;
    extern NSString * const kPOPLayerBounds;
    extern NSString * const kPOPLayerCornerRadius;
    extern NSString * const kPOPLayerBorderWidth;
    extern NSString * const kPOPLayerBorderColor;
    extern NSString * const kPOPLayerOpacity;
    extern NSString * const kPOPLayerPosition;
    extern NSString * const kPOPLayerPositionX;
    extern NSString * const kPOPLayerPositionY;
    extern NSString * const kPOPLayerRotation;
    extern NSString * const kPOPLayerRotationX;
    extern NSString * const kPOPLayerRotationY;
    extern NSString * const kPOPLayerScaleX;
    extern NSString * const kPOPLayerScaleXY;
    extern NSString * const kPOPLayerScaleY;
    extern NSString * const kPOPLayerSize;
    extern NSString * const kPOPLayerSubscaleXY;
    extern NSString * const kPOPLayerSubtranslationX;
    extern NSString * const kPOPLayerSubtranslationXY;
    extern NSString * const kPOPLayerSubtranslationY;
    extern NSString * const kPOPLayerSubtranslationZ;
    extern NSString * const kPOPLayerTranslationX;
    extern NSString * const kPOPLayerTranslationXY;
    extern NSString * const kPOPLayerTranslationY;
    extern NSString * const kPOPLayerTranslationZ;
    extern NSString * const kPOPLayerZPosition;
    extern NSString * const kPOPLayerShadowColor;
    extern NSString * const kPOPLayerShadowOffset;
    extern NSString * const kPOPLayerShadowOpacity;
    extern NSString * const kPOPLayerShadowRadius;
    
    /**
    Common CAShapeLayer property names.
    */
    extern NSString * const kPOPShapeLayerStrokeStart;
    extern NSString * const kPOPShapeLayerStrokeEnd;
    extern NSString * const kPOPShapeLayerStrokeColor;
    extern NSString * const kPOPShapeLayerFillColor;
    extern NSString * const kPOPShapeLayerLineWidth;

    ...
    


**Pop的一些东西确实很酷，即当你添加一个动画时，展示层和模型层是同步的。**

// ----使用默认属性 demo:

    POPSpringAnimation *positionAnimation = [POPSpringAnimation animationWithPropertyNamed:kPOPLayerPositionX];
    positionAnimation.velocity = @2000; 
    positionAnimation.springBounciness = 20;  // 弹簧弹力 取值范围为[0, 20]，默认值为4
    [positionAnimation setCompletionBlock:^(POPAnimation *animation, BOOL finished) {
        self.button.userInteractionEnabled = YES;
    }];
    [self.button.layer pop_addAnimation:positionAnimation forKey:@"positionAnimation"];
    
   

// ----自定义属性.

  创建一个POPAnimatableProperty对象，在初始化的时候，需要在初始化的block中设置writeBlock和readBlock

    void (^readBlock)(id obj, CGFloat values[]) 
    void (^writeBlock)(id obj, const CGFloat values[]) 

这两个block都是留给动画引擎来使用的，前者用于向目标属性写值,使用者需要做的就是从values中提取数据设置给obj；后者用于读取，也就是从objc中读取放到values中。values[] 最多支持4个数据，也就是说Pop Aniamtion属性数值的维度最大支持4维。 为了使用便捷，Pop Animation框架提供了很多现成的POPAnimatableProperty预定义，你只需要使用预定义的propertyWithName来初始化POPAnimatableProperty便可，比如以下一些预定义的propertyWithName：
 

    kPOPLayerBackgroundColor 
    ... 
    kPOPViewAlpha 
    ... 
    
####POPBasicAnimation
 
基本动画，接口方面和CABasicAniamtion很相似，使用可以提供初始值fromValue，这个 终点值toValue，动画时长duration以及决定动画节奏的timingFunction。timingFunction直接使用的CAMediaTimingFunction,是使用一个横向纵向都为一个单位的拥有两个控制点的贝赛尔曲线来描述的，横坐标为时间，纵坐标为动画进度。 

这里举一个View移动的例子：

    NSInteger height = CGRectGetHeight(self.view.bounds); 
    NSInteger width = CGRectGetWidth(self.view.bounds); 
     
    CGFloat centerX = arc4random() % width; 
    CGFloat centerY = arc4random() % height; 
     
    POPBasicAnimation *anim = [POPBasicAnimation animationWithPropertyNamed:kPOPViewCenter]; 
    anim.toValue = [NSValue valueWithCGPoint:CGPointMake(centerX, centerY)]; 
    anim.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseInEaseOut]; 
    anim.duration = 0.4; 
    [self.testView pop_addAnimation:anim forKey:@"centerAnimation"]; 

 
这里self.view上放了一个用于动画的testView，然后取一个随机坐标，进行动画。

####PopSpringAnimation
 
弹簧动画是Bezier曲线无法表述的，所以无法使用PopBasicAniamtion来实现。PopSpringAnimation便是专门用来实现弹簧动画的。
 

    POPSpringAnimation *anim = [POPSpringAnimation animationWithPropertyNamed:kPOPViewCenter]; 
     
    NSInteger height = CGRectGetHeight(self.view.bounds); 
    NSInteger width = CGRectGetWidth(self.view.bounds); 
     
    CGFloat centerX = arc4random() % width; 
    CGFloat centerY = arc4random() % height; 
     
    anim.toValue = [NSValue valueWithCGPoint:CGPointMake(centerX, centerY)]; 
    anim.springBounciness = 16; 
    anim.springSpeed = 6; 
    [self.testView pop_addAnimation:anim forKey:@"center"]; 

POPSpringAnimation主要就是需要注意下几个参数的含义：

1. springBounciness 弹簧弹力 取值范围为[0, 20]，默认值为4
2. springSpeed 弹簧速度，速度越快，动画时间越短 [0, 20]，默认为12，和springBounciness一起决定着弹簧动画的效果
3. dynamicsTension 弹簧的张力
4. dynamicsFriction 弹簧摩擦
5. dynamicsMass 质量 。张力，摩擦，质量这三者可以从更细的粒度上替代springBounciness和springSpeed控制弹簧动画的效果

####PopDecayAnimation
 
基于Bezier曲线的timingFuntion同样无法表述Decay Aniamtion，所以Pop就单独实现了一个 PopDecayAnimation，用于衰减动画。衰减动画一个很常见的地方就是 UIScrollView 滑动松开后的减速，这里就基于UIView实现一个自己的ScrollView，然后使用PopDecayAnimation实现 此代码可以详细参见 KKScrollView 的实现，当滑动手势结束时，根据结束的加速度，给衰减动画一个初始的velocity，用来决定衰减的时长。
####POPCustomAnimation
 
POPCustomAnimation 并不是基于POPPropertyAnimation的，它直接继承自PopAnimation用于创建自定义动画用的，通过POPCustomAnimationBlock类型的block进行初始化，

    typedef BOOL (^POPCustomAnimationBlock)(id target, POPCustomAnimation *animation); 

 
此block会在界面的每一帧更新的时候被调用，创建者需要在block中根据当前currentTime和elapsedTime来决定如何更新target的相关属性，以实现特定的动画。当你需要结束动画的时候就在block中返回NO，否则返回YES。
 
### Pop Animation相比于Core Animation的优点
 
Pop Animation应用于CALayer时，在动画运行的任何时刻，layer和其presentationLayer的相关属性值始终保持一致，而Core Animation做不到。 
 
Pop Animation可以应用任何NSObject的对象，而Core Aniamtion必须是CALayer。

引用：

[Facebook Pop 使用指南](http://www.cocoachina.com/industry/20140527/8565.html)

[23个Facebook Paper中的设计细节](http://www.cocoachina.com/design/20140210/7791.html)


