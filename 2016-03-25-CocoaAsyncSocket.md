---
layout: post
title: "CocoaAsyncSocket"
description: ""
category: 其它
tags: [Scrum]  
author: 饭小团  
---    
#CocoaAsyncSocket


##Introduction to Sockets
如果你是个网络新手，那就从这里开始。对socket操作和对文件操作是非常不同的，虽然APIs可能是相似的。一点对你知识的投资和理解网络基础是大有帮助的。从长远来看，他能节省你的时间，让你免于挫折。

我们会保持它的短小，主要专注于开发者：仅做开发者需要完成的目标，不会跳过重要的基础原理，以防随后引起问题。

##Sockets, Ports, and DNS
用网络用语，一台计算机就是一个有一组数字的socket主机，一个socket一端是一个称为网络连接的通信通道，另一端是另一个socket
从这一点来看，任何socket都是本地socket，在另一端的socket就是远程socket。

为了能建立连接，其中一个必须能连接到另外一个。为了连接到对方，必须知道对方的socket地址。每个socket都有一个地址。这个地址包含了两个方面：host地址和port number 。就是IP地址和本机唯一端口地址。  

一个电脑可以有多个本地地址，因为它可以有多个网络接口。  

##Networking Huh?
######关键问题在于你的网络通信连接是不可靠的
你也许会通过WiFi，数据通道，卫星等方式。但是你是不可能知道的。
其中也许会发生丢包，网络拥挤，对方服务器超负荷等情况。
事实上，这些事情每天都会发生成千上亿次，作为开发者，必须要了解这些协议并且有效的使用它们

##TCP
TCP传输控制协议可能是你用的最多的协议。浏览网络，发邮件，IM。你可能都是用的TCP。
TCP是为“长链接”设计的，所以，先初始化一个 链接握手，随后数据会进行必要的来回流动。但是最伟大事就是TCP是为在不可靠的网络环境下建立可靠链接而设计的。如果你发送一些信息通过TCP，中间一部分丢失了。这个协议会自动的指出哪一块丢失了并且重新发送它。当你发送信息时，TCP会确定信息会以正确的顺序到达。还有更多的是，该协议会检测出网络拥塞，并且相应的扩大以便所有人都能分享（啥意思？）




##TCP is a stream
TCP协议是一个单一连续无限长度的流的模型，这是一个非常重要的概念，并且是最容易引起迷惑的概念。

这意味着什么，如何影响开发者？

想象一下，你正在通过socket发送一小段信息，你可能会这样做。  

	socket.write("Hi Sandy.");
	socket.write("Are you busy tonight?");
	
数据会如何显示在另一端？反正跟你想的不一样，他不会像你想象的那样分开读取到另一端的屏幕上。

TCP不会对待这个写入成为分开的data，TCP认为所有写入都是信号流的一部分，所以当你发出了以上写入，TCP只会简单的copy数据到他的buffer：  

  	TCP_Buffer = "Hi Sandy.Are you busy tonight?"
然后尽可能的快的发送数据。  
为了能够发送数据通过网络，TCP和其他网络协议将会把这些数据分成一小片一小片，以便通过介质传输。所以TCP可能会把数据分裂成这样子：
	
    1."Hi San" , "dy.Ar" , "e you " , "busy to" , "night?"
    2."Hi Sandy.Are you busy" , " tonight?"
    3."Hi Sandy.Are you busy tonight?"

这里突出了TCP属性是个连续的流，在开发者API级别，TCP是完全没有包和分离数据的概念的。

但是，这不是一个主要的缺点，那么其他协议是如何让使用TCP工作的？

HTTP是个好例子，因为它简单，大多数人都见过他。
当客户端连接服务器并发送一个请求，它发送了一个HTTP头，每个头文件里的每一行都用CRLF作为结束。

	GET /page.html HTTP/1.1
	Host: google.com
	
此外，HTTP头文件结束是以两个CRLF作为信号的，由于这个协议指定了结束符，从TCP socket读数据直到结束符就变得容易了。  

返回刚才的例子，我们对信息这样设计终止符

	socket.write("Hi Sandy.\n");
	socket.write("Are you busy tonight?\n");

AsyncSocket 使用这种方法分离数据，如果双方都使用这个框架，那将会很容易，AsyncSocket为你做了剩余的事。

##Writes
######在你往TCP socket里写数据时发生了什么？
回忆两件事： 

* 所有数据通过网络发送和接收都会被打成碎片
* TCP处理了大量的复杂事件，比如重发丢失的包，提供按顺序的传输信息以便符合正确的次序

所以，当你写入时，数据仅仅会拷贝到系统网络栈的缓冲区。基于这点TCP开始它自己工作，以下内容组成了上述描述的行为：

* 把数据打破成一小片以便通过网咯发送出去
* 确定丢失的数据得到合适的重新发送
* 确定你的数据以合适的顺序到达远处的目的地
* 检测网络拥塞情况
* 使用牛x的算法来尽快的完成以上任务

######但是... 我如何知道何时我的数据到达了远处的目的地？

做个比喻，当你往soceket写数据，就像往邮箱寄信。操作系统就像当地邮差过来拿走信庞大的邮局系统就想网络一样邮寄你的信到目的地，邮递员把你的信放入你的朋友的邮箱就像你朋友的系统。剩下的事就是你的朋友的应用来读取他。  

那么我如何知道何时远方的目的地收到了我的数据? 这个TCP告诉不了你。最好的只有告诉你信已经到达对方的邮箱。他无法告诉你是否应用处理了数据。也许对方的app挂了，对方断电，对方挂了等等~ 这只能指望于应用层回答这个问题了。





